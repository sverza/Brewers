<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Calendario Eventi - Basket Group Beers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="stile_generale.css" />
  <style>
    :root{
      --bg:#0d0d0d; --card:#121212; --muted:#9aa4ad; --accent:#00aaff; --border:#262626;
      --win:#2ecc71; --lose:#e74c3c; --sched:#3498db; --other:#7f8c8d;
      --radius:12px; --shadow:0 6px 18px rgba(0,0,0,.35); --gap:14px; --cal-width:520px;
    }
    *{box-sizing:border-box}
    body{ background:var(--bg); color:#fff; font-family:Arial,Helvetica,sans-serif; margin:0; padding:20px; }
    h1,h2{ color:var(--accent); margin:8px 0 14px; text-align:center; }

    /* Layout */
    .layout{ display:grid; grid-template-columns:1fr; gap:var(--gap); align-items:start; max-width:1200px; margin:0 auto; }
    @media (min-width: 992px){
      .layout{ grid-template-columns:minmax(320px,var(--cal-width)) 1fr; }
      .calendar-col{ justify-self:start; }
    }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }

    #header-container,#footer-container{ margin-bottom:24px; }

    /* Legenda */
    .legenda{ text-align:center; margin-bottom:10px; }
    .badge{ display:inline-block; margin:0 6px; padding:6px 10px; border-radius:8px; font-size:.85rem; color:#fff; }
    .vittoria{ background:var(--win) } .sconfitta{ background:var(--lose) } .in_programma{ background:var(--sched) } .generico{ background:var(--other) }

    /* Header calendario */
    #calendar-header{ display:flex; align-items:center; justify-content:center; gap:14px; margin:10px 0 6px; }
    .month-nav{ font-size:1.4rem; background:none; border:none; color:var(--accent); cursor:pointer; padding:4px 8px; }
    #month-label{ color:var(--accent); font-size:1.25rem; margin:0; }

    /* Giorni settimana */
    .dow{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin:10px 0 6px; color:#b3b3b3; font-weight:600; text-align:center; }

    /* Calendario */
    .calendar-wrap{ width:100%; max-width:var(--cal-width); margin:0 auto; }
    .calendar{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
    .day{ background:#1a1a1a; border:1px solid #333; min-height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .06s ease, border-color .15s ease; }
    .day:hover{ transform:translateY(-1px); border-color:var(--accent); }
    .day.empty{ background:transparent; border:none; cursor:default; }
    .has-event{ font-weight:700; }
    .day.vittoria{ background:var(--win); color:#000; }
    .day.sconfitta{ background:var(--lose); }
    .day.in_programma{ background:var(--sched); }
    .day.generico{ background:var(--other); }

    /* Dettagli evento */
    .detail-panel{ padding:16px; position:sticky; top:20px; }
    .detail-empty{ color:var(--muted); padding:18px; }
    .detail-title{ color:var(--accent); margin:0 0 8px; display:flex; align-items:center; gap:10px; }
    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1a20; color:#cfefff; font-size:.8rem; }
    .detail-meta p{ margin:6px 0; font-size:.95rem; }
    .detail-actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .icon-btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:#0f1a20; border:1px solid var(--border); border-radius:8px; color:#cfefff; text-decoration:none; font-weight:600; }
    .icon-btn svg{ width:18px; height:18px; }

    /* Widget orizzontali */
    .widgets{ display:grid; gap:var(--gap); }
    @media (min-width: 768px){ .widgets{ grid-template-columns:1fr 1fr; } }
    .widget{ padding:12px; position:relative; }
    .widget h2{ margin-top:0; }

    /* >>> MOBILE: vero scorrimento orizzontale compatto */
    .h-scroll{
      display:flex; flex-wrap:nowrap; gap:10px; overflow-x:auto; overflow-y:hidden;
      padding:0 32px 8px; scroll-behavior:smooth;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .h-scroll::-webkit-scrollbar{ display:none; }

    .event-card{
      background:#111; border-left:4px solid var(--accent); padding:10px 12px; border-radius:10px;
      scroll-snap-align:start;
    }

    /* Larghezze & clamp testo per non allungare la pagina su mobile */
    @media (max-width: 767px){
      .event-card{ flex:0 0 88vw; max-width:88vw; }
      .event-card h3{
        margin:0 0 6px; color:var(--accent);
        overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      }
      .event-card p{
        margin:4px 0; font-size:.95rem;
        display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
      }
    }
    @media (min-width: 768px){
      .event-card{ min-width:300px; }
      .event-card h3{ margin:0 0 6px; color:var(--accent); }
      .event-card p{ margin:4px 0; font-size:.95rem; }
    }

    .scroll-btn{
      position:absolute; top:48px; width:28px; height:44px; border:none; background:#0f1a20; color:#cfefff;
      border:1px solid var(--border); border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .scroll-left{ left:6px; } .scroll-right{ right:6px; }
  </style>
</head>
<body>

  <div id="header-container"></div>

  <h1>Calendario Eventi</h1>
  <div class="legenda">
    <strong>Legenda:</strong>
    <span class="badge vittoria">Vittoria</span>
    <span class="badge sconfitta">Sconfitta</span>
    <span class="badge in_programma">In programma</span>
    <span class="badge generico">Altro</span>
  </div>

  <div class="layout">
    <!-- COLONNA CALENDARIO -->
    <div class="calendar-col">
      <div class="calendar-wrap">
        <div id="calendar-header">
          <button class="month-nav" id="prev-month" aria-label="Mese precedente">‚Üê</button>
          <h2 id="month-label" aria-live="polite"></h2>
          <button class="month-nav" id="next-month" aria-label="Mese successivo">‚Üí</button>
        </div>

        <div class="dow"><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div></div>
        <div id="calendar" class="calendar"></div>
      </div>

      <!-- DETTAGLIO EVENTO -->
      <aside class="card detail-panel" id="detail-panel">
        <div class="detail-empty" id="detail-empty">Seleziona un evento sul calendario per vedere i dettagli.</div>
        <div id="detail-content" style="display:none;">
          <h3 class="detail-title" id="det-title"></h3>
          <div class="detail-meta" id="det-meta"></div>
          <div class="detail-actions" id="det-actions"></div>
        </div>
      </aside>

      <!-- WIDGET ORIZZONTALI -->
      <div class="widgets" id="widgets-block">
        <section class="card widget" id="widget-future">
          <button class="scroll-btn scroll-left"  data-target="future-events">‚Äπ</button>
          <button class="scroll-btn scroll-right" data-target="future-events">‚Ä∫</button>
          <h2>üìÖ Prossimi Eventi</h2>
          <div id="future-events" class="h-scroll"></div>
        </section>
        <section class="card widget" id="widget-past">
          <button class="scroll-btn scroll-left"  data-target="past-events">‚Äπ</button>
          <button class="scroll-btn scroll-right" data-target="past-events">‚Ä∫</button>
          <h2>üïí Eventi Passati</h2>
          <div id="past-events" class="h-scroll"></div>
        </section>
      </div>
    </div>

    <!-- COLONNA DESTRA (desktop) -->
    <div class="right-col" id="right-col"></div>
  </div>

  <div id="footer-container"></div>

  <script>
    const MAX_FUTURE = 10;
    const MAX_PAST   = 12;

    let currentMonth = new Date().getMonth();
    let currentYear  = new Date().getFullYear();
    let eventi = [];
    let eventiPerData = {};

    const mesi = {"gennaio":1,"febbraio":2,"marzo":3,"aprile":4,"maggio":5,"giugno":6,"luglio":7,"agosto":8,"settembre":9,"ottobre":10,"novembre":11,"dicembre":12};
    const weekdaysRegex = /^(luned√¨|marted√¨|mercoled√¨|gioved√¨|venerd√¨|sabato|domenica)\s+/i;
    function parseDataItToISO(s){
      if(!s) return null;
      s = s.toLowerCase().trim().replace(weekdaysRegex,'').trim();
      const m = s.match(/^(\d{1,2})\s+([a-z√†]+)\s+(\d{4})$/i);
      if(!m) return null;
      const g=parseInt(m[1],10), mn=mesi[m[2]], a=parseInt(m[3],10);
      if(!g||!mn||!a) return null;
      return `${a}-${String(mn).padStart(2,'0')}-${String(g).padStart(2,'0')}`;
    }
    function sanitizeOra(ora){ return ora ? String(ora).replace(/!/g,'1') : null; }
    function toYYYYMMDD(iso){ return iso.replaceAll('-',''); }
    function toDDMMYYYY(iso){ const [Y,M,D]=iso.split('-'); return `${D}${M}${Y}`; }

    function determinareTipo(m, iso){
      const today = new Date().toISOString().slice(0,10);
      const pC=m["Punteggio Casa"], pT=m["Punteggio Trasferta"];
      const casa=(m["Squadra Casa"]||"").toUpperCase(), trasf=(m["Squadra Trasferta"]||"").toUpperCase();
      const brewersCasa = casa==="BREWERS", brewersTrasf=trasf==="BREWERS";

      if (iso && today<=iso && (pC==null || pT==null)) return "in_programma";
      if (pC!=null && pT!=null){
        const my = brewersCasa ? pC : pT, opp = brewersCasa ? pT : pC;
        if (my>opp) return "vittoria"; if (my<opp) return "sconfitta"; return "generico";
      }
      const w=(m["Squadra Vincitrice"]||"").toUpperCase();
      if (w==="BREWERS") return "vittoria";
      if (w && (brewersCasa||brewersTrasf)) return "sconfitta";
      return "generico";
    }
    function buildTitolo(m){ return `${(m["Squadra Casa"]||"").toUpperCase()} vs ${(m["Squadra Trasferta"]||"").toUpperCase()}`; }
    function isCasa(m){ return (m["Squadra Casa"]||"").toUpperCase()==="BREWERS"; }

    async function caricaEventi(){
      try{
        const res = await fetch('https://raw.githubusercontent.com/sverza/Brewers/main/partite/calendario.json',{cache:'no-store'});
        const partite = await res.json();

        eventi=[]; eventiPerData={};
        const todayISO = new Date().toISOString().slice(0,10);

        partite.filter(m=>{
          const c=(m["Squadra Casa"]||"").toUpperCase(), t=(m["Squadra Trasferta"]||"").toUpperCase();
          return c==="BREWERS" || t==="BREWERS";
        }).forEach(m=>{
          const iso = parseDataItToISO(m["Data"]);
          const ev = {
            dataISO: iso,
            titolo: buildTitolo(m),
            luogo: m["Luogo"]||"",
            indirizzo: m["Indirizzo"]||"",
            tipo: determinareTipo(m, iso),
            raw: m
          };
          eventi.push(ev);
          if(iso){ (eventiPerData[iso] ??= []).push(ev); }
        });

        const futuri = eventi.filter(e=>!e.dataISO || e.dataISO>=todayISO).sort(ordinaPerData).slice(0,MAX_FUTURE);
        const passati= eventi.filter(e=> e.dataISO && e.dataISO< todayISO).sort(ordinaPerData).slice(-MAX_PAST);

        renderWidget(futuri, document.getElementById('future-events'));
        renderWidget(passati, document.getElementById('past-events'));

        aggiornaCalendario();
        relocateDetailPanelOnMobile();
        wireScrollButtons();
      }catch(e){
        console.error(e);
        document.getElementById('future-events').innerHTML="<div class='event-card'><p>Errore nel caricamento.</p></div>";
        document.getElementById('past-events').innerHTML  ="<div class='event-card'><p>Errore nel caricamento.</p></div>";
      }
    }

    function ordinaPerData(a,b){
      const ai=a.dataISO || "9999-12-31", bi=b.dataISO || "9999-12-31";
      if (ai<bi) return -1; if (ai>bi) return 1; return a.titolo.localeCompare(b.titolo);
    }

    const calEl = document.getElementById('calendar');
    calEl.addEventListener('click', e=>{
      const cell = e.target.closest('.day.has-event');
      if (!cell || !cell.dataset.date) return;
      mostraDettaglioGiorno(cell.dataset.date);
      if (isMobile()){
        document.getElementById('detail-panel').scrollIntoView({behavior:'smooth', block:'start'});
      }
    });

    function aggiornaCalendario(){
      const cal = calEl; cal.innerHTML="";
      const label = new Date(currentYear, currentMonth).toLocaleString("it-IT",{month:"long",year:"numeric"});
      document.getElementById('month-label').textContent = label.charAt(0).toUpperCase()+label.slice(1);

      const first = new Date(currentYear, currentMonth, 1);
      let fd = first.getDay(); if (fd===0) fd=7;
      const days = new Date(currentYear, currentMonth+1, 0).getDate();

      for(let i=1;i<fd;i++) cal.innerHTML += `<div class="day empty" aria-hidden="true"></div>`;
      for(let g=1; g<=days; g++){
        const iso = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(g).padStart(2,'0')}`;
        const list = eventiPerData[iso];
        let cls="day";
        if(list && list.length){
          const pr={vittoria:3,sconfitta:3,in_programma:2,generico:1};
          const top = list.map(e=>e.tipo||"generico").sort((a,b)=>(pr[b]||0)-(pr[a]||0))[0] || "generico";
          cls += ` has-event ${top}`;
        }
        cal.innerHTML += `<div class="${cls}" ${list?`data-date="${iso}"`:""}>${g}</div>`;
      }
    }

    function renderWidget(lista, container){
      container.innerHTML="";
      if(!lista.length){ container.innerHTML = `<div class="event-card"><p>Nessun evento.</p></div>`; return; }
      lista.forEach(ev=>{
        const m=ev.raw;
        const vis = m["Data"] || ev.dataISO || "Data da definire";
        const ora = sanitizeOra(m["Ora"]);
        const oraTxt = ora ? ` ‚Äî <strong>Ora:</strong> ${ora}` : "";
        const ind = ev.indirizzo ? `<br><em>${ev.indirizzo}</em>` : "";
        const card = document.createElement('div');
        card.className='event-card';
        card.innerHTML = `<h3>${ev.titolo}</h3>
          <p><strong>Data:</strong> ${vis}${oraTxt}</p>
          <p><strong>Luogo:</strong> ${ev.luogo}${ind}</p>`;
        if (ev.dataISO){
          card.style.cursor='pointer';
          card.addEventListener('click', ()=>mostraDettaglioGiorno(ev.dataISO));
        }
        container.appendChild(card);
      });
    }

    function wireScrollButtons(){
      document.querySelectorAll('.scroll-btn').forEach(btn=>{
        const targetId = btn.dataset.target;
        const dir = btn.classList.contains('scroll-left') ? -1 : 1;
        btn.onclick = ()=> {
          const cont = document.getElementById(targetId);
          const step = Math.round(cont.clientWidth * 0.9);
          cont.scrollBy({left: dir*step, behavior:'smooth'});
        };
      });
    }

    async function mostraDettaglioGiorno(iso){
      const list = eventiPerData[iso];
      if(!list || !list.length) return;
      const ev = list[0], m = ev.raw;

      const badge = `<span class="chip">${isCasa(m) ? "Casa" : "Trasferta"}</span>`;
      document.getElementById('detail-empty').style.display='none';
      document.getElementById('detail-content').style.display='block';
      document.getElementById('det-title').innerHTML = `${buildTitolo(m)} ${badge}`;

      const pC=m["Punteggio Casa"], pT=m["Punteggio Trasferta"];
      const score=(pC!=null && pT!=null)?`<p><strong>Punteggio:</strong> ${m["Squadra Casa"]} ${pC} - ${pT} ${m["Squadra Trasferta"]}</p>`:"";
      const ora=sanitizeOra(m["Ora"]); const turno=m["Turno"]?`<p><strong>Turno:</strong> ${m["Turno"]}</p>`:"";

      const mapsBtn = ev.indirizzo ? makeIconBtn(
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.indirizzo || ev.luogo)}`,
        'Apri in Maps', mapsSVG(), true
      ) : null;

      document.getElementById('det-meta').innerHTML = `
        <p><strong>Data:</strong> ${m["Data"] || iso}</p>
        ${ora?`<p><strong>Ora:</strong> ${ora}</p>`:""}
        <p><strong>Luogo:</strong> ${ev.luogo}</p>
        ${ev.indirizzo?`<p><em>${ev.indirizzo}</em></p>`:""}
        ${turno}
        ${score}
      `;

      const actions = document.getElementById('det-actions'); actions.innerHTML="";
      if (mapsBtn) actions.appendChild(mapsBtn);

      const todayISO = new Date().toISOString().slice(0,10);
      const isPast = ev.dataISO && ev.dataISO < todayISO;

      if (isPast){
        const ymd = toYYYYMMDD(iso), dmy = toDDMMYYYY(iso);
        const oppSlug = normalizeOpponentFromMatch(m);

        const statsFileBase   = await findFirstExistingBase('partite',          [ `${ymd}`, `${dmy}`, `${ymd}_${oppSlug}`, `${dmy}_${oppSlug}` ]);
        const articleFileBase = await findFirstExistingBase('articoli_per_news',[ `${ymd}`, `${ymd}_@${oppSlug}`, `${ymd}_${oppSlug}` ]);

        if (statsFileBase){
          const statsUrl = `https://brewersbasketball.it/risultati_partite.html?partita=${statsFileBase}`;
          actions.appendChild(makeIconBtn(statsUrl, 'Statistiche', statsSVG()));
        }
        if (articleFileBase){
          const artUrl = `https://brewersbasketball.it/article_view.html?articolo=${articleFileBase}`;
          actions.appendChild(makeIconBtn(artUrl, 'Articolo', articleSVG()));
        }
        if (!statsFileBase && !articleFileBase){
          const note=document.createElement('span'); note.style.color='#9bb';
          note.textContent="Nessun contenuto collegato trovato per questa data."; actions.appendChild(note);
        }
      }
    }

    async function findFirstExistingBase(folder, bases){
      for (const base of bases){
        const url = `${folder}/${base}.json`;
        try{ const r = await fetch(url, {cache:'no-store'}); if (r.ok) return base; }catch{}
      }
      return null;
    }
    function normalizeOpponentFromMatch(m){
      const c=(m["Squadra Casa"]||"").toUpperCase(), t=(m["Squadra Trasferta"]||"").toUpperCase();
      const opp = c==="BREWERS" ? (m["Squadra Trasferta"]||"") : (m["Squadra Casa"]||"");
      const map = { "√†":"a","√®":"e","√©":"e","√¨":"i","√≤":"o","√π":"u","‚Äô":"","'":"" };
      return opp.replace(/[√†√®√©√¨√≤√π‚Äô']/g, s=>map[s]).replace(/[^A-Za-z0-9]/g,"").trim();
    }
    function makeIconBtn(href,label,svg,blank){
      const a=document.createElement('a'); a.className='icon-btn'; a.href=href; a.innerHTML=`${svg}<span>${label}</span>`; a.target=blank?"_blank":"_self"; return a;
    }
    function statsSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 3h2v18H3V3zm4 8h2v10H7V11zm4-6h2v16h-2V5zm4 4h2v12h-2V9zm4-8h2v20h-2V1z"/></svg>`; }
    function articleSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a2 2 0 0 1 2 2v16l-5-3-5 3V4a2 2 0 0 1 2-2zM9 6h6v2H9V6zm0 4h6v2H9v-2z"/></svg>`; }
    function mapsSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5z"/></svg>`; }

    document.getElementById('prev-month').addEventListener('click',()=>{ currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--; } aggiornaCalendario(); });
    document.getElementById('next-month').addEventListener('click',()=>{ currentMonth++; if(currentMonth>11){currentMonth=0;  currentYear++; } aggiornaCalendario(); });

    function isMobile(){ return window.matchMedia('(max-width: 991px)').matches; }
    function relocateDetailPanelOnMobile(){
      const panel = document.getElementById('detail-panel');
      const rightCol = document.getElementById('right-col');
      if (isMobile()){
        const calWrap = document.querySelector('.calendar-wrap');
        calWrap.after(panel);
      }else{
        rightCol.innerHTML=''; rightCol.appendChild(panel);
      }
    }
    window.addEventListener('resize', relocateDetailPanelOnMobile);

    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_header.html').then(r=>r.text()).then(d=>document.getElementById('header-container').innerHTML=d);
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_footer.html').then(r=>r.text()).then(d=>document.getElementById('footer-container').innerHTML=d);

    caricaEventi();
  </script>
</body>
</html>
