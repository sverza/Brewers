<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calendario Eventi - Basket Group Beers</title>
  <link rel="stylesheet" href="stile_generale.css">
  <style>
    body {
      background-color: #0d0d0d;
      color: #ffffff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1, h2 {
      color: #00aaff;
      text-align: center;
    }

    #calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }

    .month-nav {
      font-size: 1.5em;
      background: none;
      border: none;
      color: #00aaff;
      cursor: pointer;
      margin: 0 20px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 30px;
    }

    .day {
      background-color: #1a1a1a;
      border: 1px solid #333;
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .day.empty {
      cursor: default;
      background: transparent;
      border: none;
    }

    .has-event { font-weight: bold; }

    .vittoria { background-color: #2ecc71; }
    .sconfitta { background-color: #e74c3c; }
    .in_programma { background-color: #3498db; }
    .generico { background-color: #7f8c8d; }

    .event-section {
      margin-bottom: 40px;
    }

    .event-card {
      background-color: #111;
      border-left: 4px solid #00aaff;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }

    .event-card h3 {
      margin: 0 0 5px;
      color: #00aaff;
    }

    .event-card p {
      margin: 2px 0;
      font-size: 0.95em;
    }

    /* MODALE */
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #modal-content {
      background: #111;
      padding: 20px;
      border-radius: 8px;
      max-width: 520px;
      width: 90%;
      position: relative;
    }

    #modal-content h3 { color: #00aaff; }

    #modal-close {
      background: #aa0000;
      border: none;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      position: absolute;
      right: 16px;
      top: 16px;
    }

    /* Header/Footer */
    #header-container, #footer-container {
      margin-bottom: 30px;
    }

    .legenda {
      text-align: center;
      margin-bottom: 20px;
    }

    .legenda span {
      display: inline-block;
      margin: 0 5px;
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
      font-size: 0.9em;
    }

    .legenda .vittoria { background: #2ecc71; }
    .legenda .sconfitta { background: #e74c3c; }
    .legenda .in_programma { background: #3498db; }
    .legenda .generico { background: #7f8c8d; }

    /* Etichette giorni settimana (opzionale) */
    .dow {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: bold;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="header-container"></div>

  <h1>Calendario Eventi</h1>

  <div class="legenda">
    <strong>Legenda:</strong>
    <span class="vittoria">Vittoria</span>
    <span class="sconfitta">Sconfitta</span>
    <span class="in_programma">In programma</span>
    <span class="generico">Altro</span>
  </div>

  <div id="calendar-header">
    <button class="month-nav" id="prev-month" aria-label="Mese precedente">&#8592;</button>
    <h2 id="month-label" aria-live="polite"></h2>
    <button class="month-nav" id="next-month" aria-label="Mese successivo">&#8594;</button>
  </div>

  <div class="dow">
    <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
  </div>
  <div id="calendar" class="calendar"></div>

  <div class="event-section">
    <h2>ðŸ“… Prossimi Eventi</h2>
    <div id="future-events"></div>
  </div>

  <div class="event-section">
    <h2>ðŸ•’ Eventi Passati</h2>
    <div id="past-events"></div>
  </div>

  <!-- MODALE -->
  <div id="modal">
    <div id="modal-content">
      <button id="modal-close">Chiudi</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <div id="footer-container"></div>

  <script>
    // Stato calendario
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // Dati normalizzati per il calendario
    let eventi = [];          // array di oggetti {dataISO, titolo, luogo, descrizione, tipo, raw}
    let eventiPerData = {};   // { 'YYYY-MM-DD': [evento, ...] }

    // Helpers: parsing data italiana "giovedÃ¬ 9 ottobre 2025" -> "2025-10-09"
    const mesi = {
      "gennaio": 1, "febbraio": 2, "marzo": 3, "aprile": 4, "maggio": 5, "giugno": 6,
      "luglio": 7, "agosto": 8, "settembre": 9, "ottobre": 10, "novembre": 11, "dicembre": 12
    };

    function parseDataItToISO(dataStr) {
      if (!dataStr || typeof dataStr !== 'string') return null;
      const s = dataStr.trim().toLowerCase();
      // Esempi: "giovedÃ¬ 9 ottobre 2025" | "domenica 2 novembre 2025"
      // Regex: (giornoSett)? numero mese anno
      const re = /^(?:lun|mar|mer|gio|ven|sab|dom)(?:edÃ¬)?\s+(\d{1,2})\s+([a-zÃ ]+)\s+(\d{4})$|^(\d{1,2})\s+([a-zÃ ]+)\s+(\d{4})$/i;
      const m = s.match(re);
      let giorno, meseNome, anno;
      if (m) {
        if (m[1] && m[2] && m[3]) {
          giorno = parseInt(m[1], 10);
          meseNome = m[2];
          anno = parseInt(m[3], 10);
        } else if (m[4] && m[5] && m[6]) {
          giorno = parseInt(m[4], 10);
          meseNome = m[5];
          anno = parseInt(m[6], 10);
        }
      } else {
        // fallback "9 ottobre 2025"
        const parts = s.split(/\s+/);
        if (parts.length >= 3) {
          giorno = parseInt(parts[0], 10);
          meseNome = parts[1];
          anno = parseInt(parts[2], 10);
        } else {
          return null;
        }
      }
      const meseNum = mesi[meseNome];
      if (!meseNum || !giorno || !anno) return null;
      return `${anno}-${String(meseNum).padStart(2, '0')}-${String(giorno).padStart(2, '0')}`;
    }

    // Normalizzazione ora (fix "21:!5" -> "21:15")
    function sanitizeOra(ora) {
      if (!ora) return null;
      return String(ora).replace(/!/g, '1');
    }

    // Determina il tipo (colore) per una gara dei Brewers
    function determinareTipo(match, dataISO) {
      const oggiISO = new Date().toISOString().slice(0,10);
      const pCasa = (match["Punteggio Casa"] ?? null);
      const pTrasf = (match["Punteggio Trasferta"] ?? null);
      const winner = (match["Squadra Vincitrice"] || "").toUpperCase();
      const casa = (match["Squadra Casa"] || "").toUpperCase();
      const trasf = (match["Squadra Trasferta"] || "").toUpperCase();
      const isBrewersCasa = casa === "BREWERS";
      const isBrewersTrasf = trasf === "BREWERS";

      // Se data futura o oggi e non ci sono punteggi -> in_programma
      if (dataISO && oggiISO <= dataISO && (pCasa === null || pTrasf === null)) {
        return "in_programma";
      }

      // Se punteggi ci sono -> vittoria/sconfitta
      if (pCasa !== null && pTrasf !== null) {
        const brewersScore = isBrewersCasa ? pCasa : pTrasf;
        const oppScore = isBrewersCasa ? pTrasf : pCasa;
        if (brewersScore > oppScore) return "vittoria";
        if (brewersScore < oppScore) return "sconfitta";
        return "generico";
      }

      // In mancanza di punteggi, usa vincitrice se presente
      if (winner) {
        if (winner === "BREWERS") return "vittoria";
        if (isBrewersCasa || isBrewersTrasf) return "sconfitta";
      }

      return "generico";
    }

    // Costruisce titolo gara "BREWERS vs XYZ" o "XYZ vs BREWERS"
    function buildTitolo(match) {
      const casa = (match["Squadra Casa"] || "").toUpperCase();
      const trasf = (match["Squadra Trasferta"] || "").toUpperCase();
      return `${casa} vs ${trasf}`;
    }

    // Descrizione per card/modale
    function buildDescrizione(match, dataISO) {
      const turno = match["Turno"] || "";
      const ora = sanitizeOra(match["Ora"]);
      const pCasa = match["Punteggio Casa"];
      const pTrasf = match["Punteggio Trasferta"];
      const casa = match["Squadra Casa"] || "";
      const trasf = match["Squadra Trasferta"] || "";
      const punteggio = (pCasa !== null && pTrasf !== null) ? ` â€” Punteggio: ${casa} ${pCasa} - ${pTrasf} ${trasf}` : "";
      const dataStr = match["Data"] ? match["Data"] : (dataISO ? dataISO : "Data da definire");
      const oraStr = ora ? ` alle ${ora}` : "";
      const turnoStr = turno ? `Turno: ${turno}. ` : "";
      return `${turnoStr}${dataStr}${oraStr}${punteggio}`;
    }

    // Carica partite e normalizza SOLO quelle dei Brewers
    async function caricaEventi() {
      try {
        // Percorso del JSON su GitHub (come per header/footer)
        const response = await fetch('https://raw.githubusercontent.com/sverza/Brewers/main/partite/calendario.json', { cache: 'no-store' });
        const partite = await response.json();

        eventi = [];
        eventiPerData = {};
        const oggi = new Date();
        const oggiISO = oggi.toISOString().slice(0,10);

        partite
          .filter(m => {
            const casa = (m["Squadra Casa"] || "").toUpperCase();
            const trasf = (m["Squadra Trasferta"] || "").toUpperCase();
            return casa === "BREWERS" || trasf === "BREWERS";
          })
          .forEach(match => {
            const dataISO = parseDataItToISO(match["Data"]);
            const luogo = match["Luogo"] || "";
            const indirizzo = match["Indirizzo"] || "";
            const titolo = buildTitolo(match);
            const descrizione = buildDescrizione(match, dataISO);
            const tipo = determinareTipo(match, dataISO);

            const ev = {
              dataISO, // puÃ² essere null: in tal caso non entra nel calendario
              titolo,
              luogo,
              indirizzo,
              descrizione,
              tipo,
              raw: match
            };

            eventi.push(ev);

            if (dataISO) {
              if (!eventiPerData[dataISO]) eventiPerData[dataISO] = [];
              eventiPerData[dataISO].push(ev);
            }
          });

        // Divide futuri e passati (gli eventi senza data li consideriamo futuri/TBD)
        const futuri = eventi.filter(e => !e.dataISO || e.dataISO >= oggiISO);
        const passati = eventi.filter(e => e.dataISO && e.dataISO < oggiISO);

        mostraEventi(futuri.sort(ordinaPerData), document.getElementById("future-events"));
        mostraEventi(passati.sort(ordinaPerData), document.getElementById("past-events"));

        aggiornaCalendario();
      } catch (err) {
        console.error(err);
        document.getElementById("future-events").innerHTML = "<p>Errore nel caricamento degli eventi.</p>";
        document.getElementById("past-events").innerHTML = "<p>Errore nel caricamento degli eventi.</p>";
      }
    }

    function ordinaPerData(a, b) {
      const ai = a.dataISO || "9999-12-31"; // quelli senza data finiscono in fondo
      const bi = b.dataISO || "9999-12-31";
      if (ai < bi) return -1;
      if (ai > bi) return 1;
      return a.titolo.localeCompare(b.titolo);
    }

    // Rendering calendario
    function aggiornaCalendario() {
      const calendario = document.getElementById("calendar");
      calendario.innerHTML = "";

      const nomeMese = new Date(currentYear, currentMonth).toLocaleString("it-IT", { month: "long", year: "numeric" });
      document.getElementById("month-label").textContent = nomeMese.charAt(0).toUpperCase() + nomeMese.slice(1);

      // Calcolo offset per settimana che inizia di LunedÃ¬
      const first = new Date(currentYear, currentMonth, 1);
      let firstDay = first.getDay(); // 0=Dom, 1=Lun, ...
      if (firstDay === 0) firstDay = 7; // sposta Domenica a 7
      const giorniNelMese = new Date(currentYear, currentMonth + 1, 0).getDate();

      // celle vuote prima del giorno 1 (Lun=1 -> 0 celle)
      for (let i = 1; i < firstDay; i++) {
        calendario.innerHTML += `<div class="day empty" aria-hidden="true"></div>`;
      }

      // giorni del mese
      for (let g = 1; g <= giorniNelMese; g++) {
        const giornoStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(g).padStart(2, '0')}`;
        const eventiDelGiorno = eventiPerData[giornoStr];

        let classi = "day";
        if (eventiDelGiorno && eventiDelGiorno.length) {
          // Regola colore: se ci sono piÃ¹ eventi in un giorno (raro), prendi il "piÃ¹ impattante"
          // prioritÃ : vittoria/sconfitta > in_programma > generico
          const priorita = { vittoria: 3, sconfitta: 3, in_programma: 2, generico: 1 };
          const tipoTop = eventiDelGiorno
            .map(e => e.tipo || "generico")
            .sort((a,b) => (priorita[b]||0) - (priorita[a]||0))[0];
          classi += " has-event " + (tipoTop || "generico");
        }

        calendario.innerHTML += `
          <div class="${classi}" ${eventiDelGiorno ? `onclick="apriModale('${giornoStr}')"` : ""} role="button" aria-label="Giorno ${g}">
            ${g}
          </div>
        `;
      }
    }

    // Rendering liste eventi
    function mostraEventi(lista, container) {
      container.innerHTML = "";
      if (lista.length === 0) {
        container.innerHTML = "<p>Nessun evento disponibile.</p>";
        return;
      }

      lista.forEach(evento => {
        const dataVisuale = evento.raw["Data"] ? evento.raw["Data"] : (evento.dataISO || "Data da definire");
        const ora = sanitizeOra(evento.raw["Ora"]);
        const oraLine = ora ? ` â€” <strong>Ora:</strong> ${ora}` : "";
        const indirizzoLine = evento.indirizzo ? `<br><em>${evento.indirizzo}</em>` : "";
        container.innerHTML += `
          <div class="event-card">
            <h3>${evento.titolo}</h3>
            <p><strong>Data:</strong> ${dataVisuale}${oraLine}</p>
            <p><strong>Luogo:</strong> ${evento.luogo}${indirizzoLine}</p>
            <p>${evento.descrizione}</p>
          </div>
        `;
      });
    }

    // Modale
    function apriModale(dataISO) {
      const eventiDelGiorno = eventiPerData[dataISO];
      if (!eventiDelGiorno) return;

      const corpo = eventiDelGiorno.map(ev => {
        const m = ev.raw;
        const pCasa = m["Punteggio Casa"];
        const pTrasf = m["Punteggio Trasferta"];
        const score = (pCasa !== null && pTrasf !== null)
          ? `<p><strong>Punteggio:</strong> ${m["Squadra Casa"]} ${pCasa} - ${pTrasf} ${m["Squadra Trasferta"]}</p>` : "";
        const ora = sanitizeOra(m["Ora"]);
        const oraLine = ora ? `<p><strong>Ora:</strong> ${ora}</p>` : "";
        const indirizzo = ev.indirizzo ? `<p><strong>Indirizzo:</strong> ${ev.indirizzo}</p>` : "";
        return `
          <h3>${ev.titolo}</h3>
          <p><strong>Luogo:</strong> ${ev.luogo}</p>
          ${indirizzo}
          ${oraLine}
          ${score}
          <hr>
        `;
      }).join("");

      document.getElementById("modal-body").innerHTML = corpo;
      document.getElementById("modal").style.display = "flex";
    }

    // Navigazione mesi
    document.getElementById("prev-month").addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      aggiornaCalendario();
    });

    document.getElementById("next-month").addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      aggiornaCalendario();
    });

    document.getElementById("modal-close").addEventListener("click", () => {
      document.getElementById("modal").style.display = "none";
    });

    // Header / Footer esterni
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_header.html')
      .then(r => r.text()).then(d => document.getElementById('header-container').innerHTML = d);
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_footer.html')
      .then(r => r.text()).then(d => document.getElementById('footer-container').innerHTML = d);

    // Avvio
    caricaEventi();
  </script>
</body>
</html>
