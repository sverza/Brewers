<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dettaglio Giocatore</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#eaf2ff; --card:#0f1a2e; --muted:#9fb3d9; --accent:#6dc4ff; --border:#1b2a48;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    h1{font-size:28px;margin:0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;font-variant-numeric:tabular-nums}
    th{color:var(--muted);font-weight:600}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1628}
    .error{color:#ff9b9b}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1 id="title">Giocatore</h1>
      <div class="muted" id="meta">Caricamento…</div>
    </div>

    <div class="card">
      <div class="grid">
        <div><span class="pill">Partite trovate: <strong id="gamesCount">0</strong></span></div>
        <div class="muted" id="status"></div>
      </div>

      <table id="statsTable" aria-label="Statistiche giocatore">
        <thead>
          <tr id="thead-row"></tr>
        </thead>
        <tbody id="tbody-rows"></tbody>
      </table>
    </div>
  </div>

  <script>
    // =============== CONFIG =================
    const PLAYERS_DIR = "players/"; // dove metti i JSON per-giocatore
    const HEADERS = [
      "Number","Player ID","fg","fg%","3pt","3pt%","ft","ft%","oreb","dreb","foul",
      "stl","to","blk","asst","+/-","min","pts"
    ];

    // =============== HELPERS =================
    const $ = sel => document.querySelector(sel);
    function getParam(name){ return new URL(location.href).searchParams.get(name); }
    function slugify(s){
      return (s||"").toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase().replace(/[^a-z0-9_-]+/g,"_")
        .replace(/_+/g,"_").replace(/^_+|_+$/g,"");
    }
    function makeNArow(slug){
      const o = {};
      HEADERS.forEach(h => { o[h] = "NA"; });
      o["Player ID"] = slug || "NA";
      return o;
    }
    function renderTable(rows){
      // header
      const trh = $("#thead-row"); trh.innerHTML = "";
      HEADERS.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      // body
      const tb = $("#tbody-rows"); tb.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        HEADERS.forEach(h => {
          const td = document.createElement("td");
          td.textContent = (r[h] ?? "NA");
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
    }

    // =============== MAIN =================
    (async () => {
      const raw = getParam("player");
      const slug = slugify(raw);
      $("#title").textContent = raw || slug || "Giocatore";
      $("#meta").textContent = slug ? `File previsto: ${PLAYERS_DIR}${slug}.json` : "Parametro ?player mancante";

      if(!slug){
        $("#status").innerHTML = '<span class="error">Parametro assente: mostro dati "NA".</span>';
        renderTable([makeNArow()]);
        $("#gamesCount").textContent = "0";
        return;
      }

      const url = `${PLAYERS_DIR}${slug}.json`;
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok){
          // 404 o altro -> fallback NA senza redirect
          $("#status").innerHTML = `<span class="error">Nessun JSON trovato per "${slug}". Dati impostati a "NA".</span>`;
          renderTable([makeNArow(slug)]);
          $("#gamesCount").textContent = "0";
          return;
        }

        const data = await res.json();
        // Atteso: array di righe o oggetto singolo; normalizziamo a array.
        const rows = Array.isArray(data) ? data : [data];

        // Se l'array è vuoto o non contiene il player -> fallback NA
        const containsPlayer = rows.some(r => {
          const pid = (r["Player ID"] || r["player_id"] || r["player"] || "").toString().toLowerCase();
          return pid.includes(slug);
        });

        if(!containsPlayer){
          $("#status").innerHTML = `<span class="error">Il giocatore non compare nei dati. Dati impostati a "NA".</span>`;
          renderTable([makeNArow(slug)]);
          $("#gamesCount").textContent = "0";
          return;
        }

        // Rendering “as-is”
        renderTable(rows);
        // Se hai un campo che indica il numero gare, usalo; altrimenti calcolo naive:
        $("#gamesCount").textContent = rows.length.toString();
        $("#status").textContent = "Dati caricati.";
      }catch(err){
        console.error(err);
        $("#status").innerHTML = `<span class="error">Errore di rete/parsing. Dati impostati a "NA".</span>`;
        renderTable([makeNArow(slug)]);
        $("#gamesCount").textContent = "0";
      }
    })();
  </script>
</body>
</html>
