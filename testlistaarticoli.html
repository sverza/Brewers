<!DOCTYPE html>
line-height:1.2; cursor:pointer;
background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23c7c9cc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
background-repeat:no-repeat; background-position:right 12px center; background-size:16px 16px
}
select:focus{outline:2px solid var(--ring); box-shadow:0 0 0 4px rgba(0,170,255,.15)}
.toggle-btn{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.toggle-btn[aria-pressed="true"]{border-color:var(--brand);background:linear-gradient(180deg,var(--brand),#0085c7);color:#fff}


/* Articles grid/list */
.articles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px}
.articles-list{display:flex;flex-direction:column;gap:18px}


.article-card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:.2s;min-height:100%}
.article-card:hover{transform:translateY(-2px);border-color:var(--ring)}


.article-cover{width:100%;height:200px;object-fit:cover;background:#0b0c10}
.articles-list .article-card{flex-direction:row;gap:14px;align-items:stretch;height:var(--list-card-h);min-height:var(--list-card-h);overflow:hidden}
.articles-list .article-cover{width:260px;height:100%;object-fit:cover;flex-shrink:0}


.card-body{padding:14px;display:flex;flex-direction:column;gap:10px;flex:1;min-width:0}
.articles-list .card-body{display:grid;grid-template-rows:auto auto 1fr auto;gap:8px;min-width:0;min-height:0}


.article-title{margin:0;font-size:1.08rem;font-weight:800;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word}
.article-excerpt{margin:0;font-size:.95rem;color:var(--muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.35;word-break:break-word}
$1


/* Chip base + colori per categoria */
.chip{font-size:.75rem;font-weight:700;padding:6px 10px;border-radius:999px;background:rgba(0,170,255,.15);color:var(--brand);display:inline-block}
.article-card[data-category="report_partita"] .chip{background:rgba(255,105,135,.18);color:#ff6b8b;border:1px solid rgba(255,105,135,.35)}
.article-card[data-category="mercato"] .chip{background:rgba(0,170,255,.18);color:#00aaff;border:1px solid rgba(0,170,255,.35)}
.article-card[data-category="general"] .chip{background:rgba(102,252,241,.18);color:#66fcf1;border:1px solid rgba(102,252,241,.35)}




/* Mobile tuning */
@media (max-width: 600px){
:root{ --list-card-h: 160px; }


/* Griglia: 2 card per riga su mobile */
.articles-grid{ grid-template-columns: repeat(2, 1fr); gap:10px; }
.articles-grid .article-cover{ height:120px; }
.articles-grid .card-body{ padding:10px; gap:6px; }
.articles-grid .article-title{ font-size:0.98rem; -webkit-line-clamp:2; }
.articles-grid .article-excerpt{ font-size:.82rem; -webkit-line-clamp:2; }
.articles-grid .read-button{ padding:.45rem .7rem; font-size:.9rem; }


/* Lista: altezza uniforme e immagine a piena altezza */
.articles-list .article-card{height:var(--list-card-h);min-height:var(--list-card-h);}
.articles-list .article-cover{width:140px;height:100%;object-fit:cover}
.articles-list .card-body{padding:10px;gap:8px;grid-template-rows:auto auto 1fr auto}
.article-title{font-size:1rem}
.article-excerpt{font-size:.85rem}
}
.articles-grid{ grid-template-columns: repeat(2, 1fr); gap:10px; }
.article-cover{ height:120px; }
.articles-grid .card-body{ padding:10px; gap:6px; }
.articles-grid .article-title{ font-size:0.98rem; -webkit-line-clamp:2; }
.articles-grid .article-excerpt{ font-size:.82rem; -webkit-line-clamp:2; }
.articles-grid .read-button{ padding:.4rem .6rem; font-size:.85rem; }


.articles-list{ gap:10px; }
.articles-list .article-card{ height:var(--list-card-h); min-height:var(--list-card-h); }
.articles-list .article-cover{ width:140px; height:100%; object-fit:cover; }
.articles-list .card-body{ padding:10px; gap:8px; min-width:0; grid-template-rows:auto auto 1fr auto; }
.article-title{ font-size:1rem; }
.article-excerpt{ font-size:.85rem; -webkit-line-clamp:2; }
.read-button{ padding:.45rem .7rem; font-size:.9rem; }
}
</style>
</head>
<body>
  <div id="header-container"></div>

  <div class="container">
    <h2>Ultimi Articoli</h2>
    <section class="carousel-section">
      <div class="carousel-container" id="carousel-container"></div>
      <div class="carousel-dots" id="carousel-dots"></div>
    </section>

    <h2>Tutti gli Articoli</h2>
    <div class="filters">
      <label for="filter-category">Filtra per categoria</label>
      <select id="filter-category">
        <option value="all">Tutte le categorie</option>
        <option value="report_partita">Report</option>
        <option value="mercato">Mercato</option>
        <option value="general">Generale</option>
      </select>
      <button id="viewToggle" class="toggle-btn" aria-pressed="false"><span class="emoji">ðŸ”³</span><span class="label">Griglia</span></button>
    </div>

    <div id="articles" class="articles-grid"></div>

    <div class="pagination">
      <button id="prevPage">Â«</button>
      <span class="page-number" id="pageNumber">1</span>
      <button id="nextPage">Â»</button>
    </div>
  </div>

  <div id="footer-container"></div>

  <script>
    // HEADER con menu mobile
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_header.html')
      .then(r=>r.text())
      .then(html=>{
        document.getElementById('header-container').innerHTML=html;
        const icon = document.getElementById('menu-icon');
        const iconFixed = document.getElementById('menu-icon-fixed');
        const menu = document.getElementById('brewers-menu');
        const overlay = document.getElementById('menu-overlay');
        function toggleMenu(){
          if(!menu||!overlay) return;
          const opening = !menu.classList.contains('open');
          menu.classList.toggle('open');
          overlay.classList.toggle('active');
          if(icon) icon.classList.add('bounce');
          if(iconFixed) iconFixed.classList.add('bounce');
          setTimeout(()=>{ icon&&icon.classList.remove('bounce'); iconFixed&&iconFixed.classList.remove('bounce'); },500);
          if(iconFixed) iconFixed.style.display = opening ? 'block' : 'none';
        }
        icon && icon.addEventListener('click', toggleMenu);
        iconFixed && iconFixed.addEventListener('click', toggleMenu);
        overlay && overlay.addEventListener('click', ()=>{
          menu && menu.classList.remove('open');
          overlay && overlay.classList.remove('active');
          if(iconFixed) iconFixed.style.display='none';
        });
      });

    // FOOTER
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_footer.html')
      .then(r=>r.text())
      .then(html=>{ document.getElementById('footer-container').innerHTML=html; });

    function dateInfoFromFilename(fname){
      const m = (fname || '').match(/^(\d{8})/);
      if(!m) return null;
      const raw = m[1];
      const y = raw.slice(0,4), mo = raw.slice(4,6), d = raw.slice(6,8);
      const iso = `${y}-${mo}-${d}`;
      const ts = new Date(`${iso}T00:00:00`).getTime();
      return { iso, ts };
    }

    function formatDateIT(dateStr){
      const d = new Date(dateStr);
      if(isNaN(d)) return dateStr || '';
      return d.toLocaleDateString('it-IT', { year:'numeric', month:'short', day:'2-digit' });
    }

    function labelFromCategory(cat){
      if(cat==='report_partita') return 'Report';
      if(cat==='mercato') return 'Mercato';
      return 'Generale';
    }

    const articlesPerPage = 12;
    let allArticles = [];
    let currentPage = 1;
    let isGrid = (localStorage.getItem('viewMode') || 'grid') === 'grid';

    function applyView(){
      const c = document.getElementById('articles');
      c.classList.toggle('articles-grid', isGrid);
      c.classList.toggle('articles-list', !isGrid);
      const btn = document.getElementById('viewToggle');
      if(btn){
        btn.setAttribute('aria-pressed', (!isGrid).toString());
        const label = btn.querySelector('.label');
        const emoji = btn.querySelector('.emoji');
        if(label) label.textContent = isGrid ? 'Griglia' : 'Lista';
        if(emoji) emoji.textContent = isGrid ? 'ðŸ”³' : 'ðŸ“„';
      }
    }

    document.getElementById('viewToggle').addEventListener('click',(e)=>{
      e.preventDefault();
      isGrid = !isGrid;
      localStorage.setItem('viewMode', isGrid ? 'grid' : 'list');
      applyView();
    });

    const githubApiUrl = 'https://api.github.com/repos/sverza/Brewers/contents/articoli_per_news';

    async function fetchArticlesFromGitHub(){
      try{
        const res = await fetch(githubApiUrl);
        const data = await res.json();
        const jsonFiles = (data||[]).filter(f=>f && f.name && f.name.endsWith('.json'));
        const articlePromises = jsonFiles.map(file =>
          fetch(file.download_url)
            .then(r=>r.json())
            .then(j=>{
              const info = dateInfoFromFilename(file.name);
              return ({
                title: j.title,
                excerpt: j.short_description,
                dateISO: info ? info.iso : (j.date || ''),
                dateTS: info ? info.ts : (j.date ? new Date(j.date).getTime() : -Infinity),
                category: j.category || 'general',
                image: `articoli_per_news/images/${j.img_name}`,
                link: `testpagearticle.html?articolo=${file.name.replace('.json','')}`,
                filename: file.name
              });
            })
            .catch(()=>null)
        );
        allArticles = (await Promise.all(articlePromises)).filter(Boolean);
        renderArticles();
        renderCarousel(allArticles);
      }catch(err){
        console.error('Articoli:',err);
        document.getElementById('articles').innerHTML = `<div class="empty-state">Impossibile caricare gli articoli al momento.</div>`;
      }
    }

    function renderArticles(){
      const filter = document.getElementById('filter-category').value;
      const filtered = allArticles
        .filter(a => filter==='all' || a.category===filter)
        .sort((a,b)=> (b.dateTS||-Infinity) - (a.dateTS||-Infinity));

      const start = (currentPage-1)*articlesPerPage;
      const end = start + articlesPerPage;
      const visible = filtered.slice(start, end);

      const container = document.getElementById('articles');
      if(!visible.length){
        container.innerHTML = `<div class="empty-state">Nessun articolo per questa categoria.</div>`;
      } else {
        container.innerHTML = visible.map(a=>`
          <article class="article-card" data-category="${a.category}">
            <img src="${a.image}" class="article-cover" alt="Anteprima articolo">
            <div class="card-body">
              <span class="chip">${labelFromCategory(a.category)}</span>
              <h3 class="article-title">${a.title}</h3>
              <p class="article-excerpt">${a.excerpt}</p>
              <div class="card-footer">
                <time class="article-date" datetime="${a.dateISO}">${formatDateIT(a.dateISO)}</time>
                <a href="${a.link}"><button class="read-button">Leggi</button></a>
              </div>
            </div>
          </article>`).join('');
      }

      document.getElementById('prevPage').disabled = currentPage===1;
      document.getElementById('nextPage').disabled = end>=filtered.length;
      document.getElementById('pageNumber').textContent = currentPage;
      applyView();
    }

    function renderCarousel(articles){
      const container = document.getElementById('carousel-container');
      const dotsWrap = document.getElementById('carousel-dots');
      const items = [...articles].sort((a,b)=> (b.dateTS||-Infinity) - (a.dateTS||-Infinity)).slice(0,5);

      container.innerHTML = items.map(a=>`
        <div class="carousel-card" style="background-image:url('${a.image}')">
          <div class="content">
            <h3>${a.title}</h3>
            <p>${a.excerpt}</p>
            <div class="carousel-bottom">
              <div class="badge">${formatDateIT(a.dateISO)}</div>
              <a href="${a.link}"><button class="read-button">Leggi</button></a>
            </div>
          </div>
        </div>`).join('');

      dotsWrap.innerHTML = items.map((_,i)=>`<button class="carousel-dot ${i===0?'active':''}" data-index="${i}"></button>`).join('');
      const dots = [...dotsWrap.querySelectorAll('.carousel-dot')];
      const cards = [...container.querySelectorAll('.carousel-card')];

      dots.forEach(dot=>{
        dot.addEventListener('click',()=>{
          const idx = +dot.dataset.index;
          cards[idx].scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
        });
      });

      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            const idx = cards.indexOf(e.target);
            dots.forEach((d,i)=> d.classList.toggle('active', i===idx));
          }
        });
      }, { root: container, threshold: 0.6 });

      cards.forEach(card=> io.observe(card));
    }

    document.getElementById('filter-category').addEventListener('change',()=>{ currentPage=1; renderArticles(); });
    document.getElementById('prevPage').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderArticles(); } });
    document.getElementById('nextPage').addEventListener('click',()=>{ currentPage++; renderArticles(); });

    document.getElementById('articles').innerHTML = `<div class="empty-state">Caricamento articoliâ€¦</div>`;
    applyView();
    fetchArticlesFromGitHub();
  </script>
</body>
</html>
