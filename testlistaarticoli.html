<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Articoli - Basket Group Beers</title>
<link href="https://fonts.googleapis.com/css2?family=Quattrocento&family=Quattrocento+Sans:wght@400;700&display=swap" rel="stylesheet">
<style>
@font-face {
font-family: 'Strike Fighter Laser';
src: url('https://raw.githubusercontent.com/sverza/Brewers/main/Font/strikefighterlaser.ttf') format('truetype');
}


:root{
--bg:#0a0a0a; --panel:#0f1115; --panel-2:#12151b; --text:#f0f0f0;
--muted:#c7c9cc; --muted-2:#9aa0a6; --brand:#00aaff; --brand-2:#66fcf1; --accent:#45a29e;
--ring: rgba(0,170,255,.35);
--shadow: 0 6px 24px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.02) inset;
--radius: 16px;
--list-card-h: 220px;
}


body { margin:0; background:var(--bg); font-family:'Quattrocento Sans',sans-serif; color:var(--text); }


#header-container{position:sticky;top:0;z-index:1000;background:#090909;backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}


.container{max-width:1100px;margin:auto;padding:24px}


h2{font-family:'Strike Fighter Laser',sans-serif;font-size:clamp(22px,3vw,32px);text-align:center;margin:1.2rem 0 1rem;color:#fff}


/* Filters & toggle */
.filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;margin-bottom:1rem}
label{font-size:.9rem;color:var(--muted-2)}
select{
appearance:none;-webkit-appearance:none;-moz-appearance:none;
background:linear-gradient(180deg,var(--panel),var(--panel-2));
color:var(--text); padding:10px 40px 10px 12px; border:1px solid var(--brand); border-radius:10px;
line-height:1.2; cursor:pointer;
background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23c7c9cc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
background-repeat:no-repeat; background-position:right 12px center; background-size:16px 16px
}
select:focus{outline:2px solid var(--ring); box-shadow:0 0 0 4px rgba(0,170,255,.15)}
.toggle-btn{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.toggle-btn[aria-pressed="true"]{border-color:var(--brand);background:linear-gradient(180deg,var(--brand),#0085c7);color:#fff}


/* Articles grid/list */
.articles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px}
.articles-list{display:flex;flex-direction:column;gap:18px}


.article-card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:.2s;min-height:100%}
.article-card:hover{transform:translateY(-2px);border-color:var(--ring)}


.article-cover{width:100%;height:200px;object-fit:cover;background:#0b0c10}
.articles-list .article-card{flex-direction:row;gap:14px;align-items:stretch;height:var(--list-card-h);min-height:var(--list-card-h);overflow:hidden}
.articles-list .article-cover{width:260px;height:100%;object-fit:cover;flex-shrink:0}


.card-body{padding:14px;display:flex;flex-direction:column;gap:10px;flex:1;min-width:0}
.articles-list .card-body{display:grid;grid-template-rows:auto auto 1fr auto;gap:8px;min-width:0;min-height:0}


.article-title{margin:0;font-size:1.08rem;font-weight:800;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word}
.article-excerpt{margin:0;font-size:.95rem;color:var(--muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.35;word-break:break-word}
.card-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:12px}


/* Mobile tuning */
@media (max-width: 600px){
:root{ --list-card-h: 160px; }
</head>
<body>
  <div id="header-container"></div>

  <div class="container">
    <h2>Ultimi Articoli</h2>
    <section class="carousel-section">
      <div class="carousel-container" id="carousel-container"></div>
      <div class="carousel-dots" id="carousel-dots"></div>
    </section>

    <h2>Tutti gli Articoli</h2>
    <div class="filters">
      <label for="filter-category">Filtra per categoria</label>
      <select id="filter-category">
        <option value="all">Tutte le categorie</option>
        <option value="report_partita">Report</option>
        <option value="mercato">Mercato</option>
        <option value="general">Generale</option>
      </select>
      <button id="viewToggle" class="toggle-btn" aria-pressed="false" title="Passa a lista"><span class="emoji">ðŸ”³</span><span class="label">Griglia</span></button>
    </div>

    <div id="articles" class="articles-grid"></div>

    <div class="pagination">
      <button id="prevPage" aria-label="Pagina precedente">Â«</button>
      <span class="page-number" id="pageNumber">1</span>
      <button id="nextPage" aria-label="Pagina successiva">Â»</button>
    </div>
  </div>

  <div id="footer-container"></div>

  <script>
    // HEADER con menu mobile
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_header.html')
      .then(r=>{ if(!r.ok) throw new Error('Errore header'); return r.text(); })
      .then(html=>{
        document.getElementById('header-container').innerHTML=html;
        // Bind del menu mobile
        const icon = document.getElementById('menu-icon');
        const iconFixed = document.getElementById('menu-icon-fixed');
        const menu = document.getElementById('brewers-menu');
        const overlay = document.getElementById('menu-overlay');
        function toggleMenu(){
          if(!menu||!overlay) return;
          const opening = !menu.classList.contains('open');
          menu.classList.toggle('open');
          overlay.classList.toggle('active');
          if(icon) icon.classList.add('bounce');
          if(iconFixed) iconFixed.classList.add('bounce');
          setTimeout(()=>{ icon&&icon.classList.remove('bounce'); iconFixed&&iconFixed.classList.remove('bounce'); },500);
          if(iconFixed) iconFixed.style.display = opening ? 'block' : 'none';
        }
        icon && icon.addEventListener('click', toggleMenu);
        iconFixed && iconFixed.addEventListener('click', toggleMenu);
        overlay && overlay.addEventListener('click', ()=>{
          menu && menu.classList.remove('open');
          overlay && overlay.classList.remove('active');
          if(iconFixed) iconFixed.style.display='none';
        });
      })
      .catch(err=>console.error('Header:',err));

    // FOOTER
    fetch('https://raw.githubusercontent.com/sverza/Brewers/main/widget/brewers_footer.html')
      .then(r=>{ if(!r.ok) throw new Error('Errore footer'); return r.text(); })
      .then(html=>{ document.getElementById('footer-container').innerHTML=html; })
      .catch(err=>console.error('Footer:',err));

    // --- Util: data da filename ---
    // Estrae la data in formato YYYY-MM-DD dai file con prefisso 8 cifre (es. 20241019_@iamaballer.json)
    function dateInfoFromFilename(fname){
      const m = (fname || '').match(/^(\d{8})/);
      if(!m) return null;
      const raw = m[1];
      const y = raw.slice(0,4), mo = raw.slice(4,6), d = raw.slice(6,8);
      const iso = `${y}-${mo}-${d}`; // es. 2024-10-19
      const ts = new Date(`${iso}T00:00:00`).getTime();
      return { iso, ts };
    }

    // --- Formattazione data IT ---
    function formatDateIT(dateStr){
      const d = new Date(dateStr);
      if(isNaN(d)) return dateStr || '';
      return d.toLocaleDateString('it-IT', { year:'numeric', month:'short', day:'2-digit' });
    }

    // --- Mappatura categoria -> label ---
    function labelFromCategory(cat){
      if(cat==='report_partita') return 'Report';
      if(cat==='mercato') return 'Mercato';
      return 'Generale';
    }

    // --- Articoli dinamici ---
    const articlesPerPage = 12;
    let allArticles = [];
    let currentPage = 1;

    // vista persistita
    let isGrid = (localStorage.getItem('viewMode') || 'grid') === 'grid';

    function applyView(){
      const c = document.getElementById('articles');
      c.classList.toggle('articles-grid', isGrid);
      c.classList.toggle('articles-list', !isGrid);
      const btn = document.getElementById('viewToggle');
      if(btn){
        btn.setAttribute('aria-pressed', (!isGrid).toString()); // true => Lista
        const label = btn.querySelector('.label');
        const emoji = btn.querySelector('.emoji');
        if(label) label.textContent = isGrid ? 'Griglia' : 'Lista';
        if(emoji) emoji.textContent = isGrid ? 'ðŸ”³' : 'ðŸ“„';
        btn.title = isGrid ? 'Passa a lista' : 'Passa a griglia';
      }
    }

    document.getElementById('viewToggle').addEventListener('click',(e)=>{
      e.preventDefault();
      isGrid = !isGrid;
      localStorage.setItem('viewMode', isGrid ? 'grid' : 'list');
      applyView();
    });

    const githubApiUrl = 'https://api.github.com/repos/sverza/Brewers/contents/articoli_per_news';

    async function fetchArticlesFromGitHub(){
      try{
        const res = await fetch(githubApiUrl);
        const data = await res.json();
        const jsonFiles = (data||[]).filter(f=>f && f.name && f.name.endsWith('.json'));
        const articlePromises = jsonFiles.map(file =>
          fetch(file.download_url)
            .then(r=>r.json())
            .then(j=>{
              const info = dateInfoFromFilename(file.name);
              return ({
                title: j.title,
                excerpt: j.short_description,
                dateISO: info ? info.iso : (j.date || ''),
                dateTS: info ? info.ts : (j.date ? new Date(j.date).getTime() : -Infinity),
                category: j.category || 'general',
                image: `articoli_per_news/images/${j.img_name}`,
                link: `testpagearticle.html?articolo=${file.name.replace('.json','')}`,
                filename: file.name
              });
            })
            .catch(()=>null)
        );
        allArticles = (await Promise.all(articlePromises)).filter(Boolean);
        renderArticles();
        renderCarousel(allArticles);
      }catch(err){
        console.error('Articoli:',err);
        document.getElementById('articles').innerHTML = `<div class="empty-state">Impossibile caricare gli articoli al momento.</div>`;
      }
    }

    function renderArticles(){
      const filter = document.getElementById('filter-category').value;
      const filtered = allArticles
        .filter(a => filter==='all' || a.category===filter)
        // Ordina per data dal NOME FILE (decrescente)
        .sort((a,b)=> (b.dateTS||-Infinity) - (a.dateTS||-Infinity));

      const start = (currentPage-1)*articlesPerPage;
      const end = start + articlesPerPage;
      const visible = filtered.slice(start, end);

      const container = document.getElementById('articles');
      if(!visible.length){
        container.innerHTML = `<div class="empty-state">Nessun articolo per questa categoria.</div>`;
      } else {
        container.innerHTML = visible.map(a=>`
          <article class="article-card" data-category="${a.category}">
            <img src="${a.image}" class="article-cover" alt="Anteprima articolo">
            <div class="card-body">
              <span class="chip">${labelFromCategory(a.category)}</span>
              <h3 class="article-title">${a.title}</h3>
              <p class="article-excerpt">${a.excerpt}</p>
              <div class="card-footer">
                <time class="article-date" datetime="${a.dateISO}">${formatDateIT(a.dateISO)}</time>
                <a href="${a.link}"><button class="read-button">Leggi</button></a>
              </div>
            </div>
          </article>`).join('');
      }

      document.getElementById('prevPage').disabled = currentPage===1;
      document.getElementById('nextPage').disabled = end>=filtered.length;
      document.getElementById('pageNumber').textContent = currentPage;

      applyView(); // applica la vista corrente anche dopo il render
    }

    function renderCarousel(articles){
      const container = document.getElementById('carousel-container');
      const dotsWrap = document.getElementById('carousel-dots');
      // Ordina per data dal NOME FILE (decrescente) e prendi i 5 piÃ¹ recenti
      const items = [...articles]
        .sort((a,b)=> (b.dateTS||-Infinity) - (a.dateTS||-Infinity))
        .slice(0,5);

      container.innerHTML = items.map(a=>`
        <div class="carousel-card" style="background-image:url('${a.image}')">
          <div class="content">
            <h3>${a.title}</h3>
            <p>${a.excerpt}</p>
            <div class="carousel-bottom">
              <div class="badge">${formatDateIT(a.dateISO)}</div>
              <a href="${a.link}"><button class="read-button">Leggi</button></a>
            </div>
          </div>
        </div>`).join('');

      // Dots
      dotsWrap.innerHTML = items.map((_,i)=>`<button class="carousel-dot ${i===0?'active':''}" data-index="${i}"></button>`).join('');
      const dots = [...dotsWrap.querySelectorAll('.carousel-dot')];
      const cards = [...container.querySelectorAll('.carousel-card')];

      // Click su puntini
      dots.forEach(dot=>{
        dot.addEventListener('click',()=>{
          const idx = +dot.dataset.index;
          cards[idx].scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
        });
      });

      // Aggiornamento attivo con IntersectionObserver (robusto a larghezze variabili)
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            const idx = cards.indexOf(e.target);
            dots.forEach((d,i)=> d.classList.toggle('active', i===idx));
          }
        });
      }, { root: container, threshold: 0.6 });

      cards.forEach(card=> io.observe(card));
    }

    // Eventi UI
    document.getElementById('filter-category').addEventListener('change',()=>{ currentPage=1; renderArticles(); });
    document.getElementById('prevPage').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderArticles(); } });
    document.getElementById('nextPage').addEventListener('click',()=>{ currentPage++; renderArticles(); });

    // First paint + fetch
    document.getElementById('articles').innerHTML = `<div class="empty-state">Caricamento articoliâ€¦</div>`;
    applyView();
    fetchArticlesFromGitHub();
  </script>
</body>
</html>
